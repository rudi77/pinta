# Story 2.3.1: Dynamic Pricing Engine

## Status
**Draft**

## Story
**As a** painter/Maler,
**I want** market-competitive prices that are automatically calculated based on regional data and material costs,
**so that** my quotes are competitive and profitable in my local market.

## Acceptance Criteria
1. **Regional Price Variation**: System calculates different pricing based on postal code for all 16 German federal states
2. **Material Price Integration**: System integrates with external APIs to get current material prices for paints, primers, and supplies  
3. **Working Time Algorithm**: System calculates labor time with ±15% accuracy based on project complexity, area, and surface conditions
4. **User-Configurable Profit Margins**: Each user can set and adjust their profit margin percentage in their profile settings
5. **Price Transparency**: System shows breakdown of material costs, labor costs, and profit margin to user (not customer)
6. **Quote Validation**: Generated quotes are within 10-20% of regional market rates for similar projects

## Tasks / Subtasks

- [ ] **Task 1: Create Regional Pricing Database Schema and Model (AC: 1)**
  - [ ] Create `RegionalPricing` model with federal state, postal code ranges, and base rates
  - [ ] Add migration for regional pricing tables  
  - [ ] Seed database with initial pricing data for all 16 German states
  - [ ] Create postal code lookup service for region determination

- [ ] **Task 2: Implement Material Price API Integration (AC: 2)**
  - [ ] Research and integrate with German building supplies API (e.g., Bauhaus, OBI, or wholesale pricing APIs)
  - [ ] Create `MaterialPriceService` to fetch and cache current prices
  - [ ] Add material price models and database tables
  - [ ] Implement fallback pricing for API failures

- [ ] **Task 3: Develop Working Time Calculation Algorithm (AC: 3)**  
  - [ ] Create `WorkingTimeCalculator` service with complexity scoring
  - [ ] Implement area-based time calculations (sqm to hours conversion)
  - [ ] Add surface condition multipliers (new wall vs repairs vs difficult access)
  - [ ] Build project type templates (interior painting, exterior, specialty work)
  - [ ] Validate algorithm accuracy against real-world data

- [ ] **Task 4: Create User Profit Margin Management (AC: 4)**
  - [ ] Add profit margin fields to User model 
  - [ ] Create user settings API endpoints for margin configuration
  - [ ] Implement margin validation (prevent negative or excessive margins)
  - [ ] Add default margin settings for new users

- [ ] **Task 5: Build Dynamic Pricing Engine Core (AC: 1, 2, 3, 4)**
  - [ ] Create `DynamicPricingEngine` service class
  - [ ] Implement price calculation workflow: region → materials → time → margin
  - [ ] Add pricing result caching for performance
  - [ ] Create pricing audit trail for debugging

- [ ] **Task 6: Integrate Pricing Engine with Quote Generation (AC: 5, 6)**
  - [ ] Update AI service to use dynamic pricing instead of static estimates
  - [ ] Modify quote creation to show price breakdown internally
  - [ ] Add pricing transparency to quote management interface  
  - [ ] Implement quote validation against market rate boundaries

- [ ] **Task 7: Create Pricing Configuration UI (AC: 4)**
  - [ ] Build user settings page for profit margin configuration
  - [ ] Add pricing preview functionality to show sample calculations
  - [ ] Create regional pricing admin interface (for system administration)

- [ ] **Task 8: Unit Testing (AC: 1, 2, 3, 4, 5, 6)**
  - [ ] Test regional pricing calculations for different postal codes
  - [ ] Test material price API integration and fallback scenarios
  - [ ] Test working time algorithm with various project scenarios
  - [ ] Test profit margin calculations and edge cases
  - [ ] Test complete pricing engine workflow integration

## Dev Notes

### Previous Story Insights
No previous story context available - this is a new pricing system implementation.

### Data Models
**Source: backend/src/models/models.py analysis**

**Existing Models to Extend:**
- `User` model: Add profit margin configuration fields (`default_profit_margin`, `min_profit_margin`, `max_profit_margin`)
- `Quote` model: Already has pricing fields (`total_amount`, `labor_hours`, `hourly_rate`, `material_cost`, `additional_costs`) - will be populated by new pricing engine
- `QuoteItem` model: Contains detailed line items - pricing engine will calculate `unit_price` and `total_price` fields

**New Models Required:**
```python
class RegionalPricing(Base):
    __tablename__ = "regional_pricing"
    id = Column(Integer, primary_key=True)
    federal_state = Column(String(50), nullable=False)  # Baden-Württemberg, Bayern, etc.
    postal_code_start = Column(Integer, nullable=False) 
    postal_code_end = Column(Integer, nullable=False)
    labor_rate_multiplier = Column(Float, default=1.0)  # Regional adjustment factor
    material_cost_multiplier = Column(Float, default=1.0)
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())

class MaterialPrice(Base):
    __tablename__ = "material_prices"
    id = Column(Integer, primary_key=True)
    material_name = Column(String(100), nullable=False)
    category = Column(String(50), nullable=False)  # paint, primer, tools, etc.
    unit = Column(String(20), nullable=False)  # liter, kg, piece
    price_per_unit = Column(Float, nullable=False)
    supplier = Column(String(100))
    region = Column(String(50))  # optional regional pricing
    valid_until = Column(DateTime)
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
```

### API Specifications
**Source: backend/src/routes/quotes.py analysis**

**Existing Endpoints to Modify:**
- `POST /api/v1/quotes/`: Update to use dynamic pricing engine
- `POST /api/v1/quotes/{quote_id}/generate-ai`: Integrate with new pricing calculations

**New Endpoints Required:**
```python
# Pricing Management
GET /api/v1/pricing/regional/{postal_code} - Get regional pricing info
GET /api/v1/pricing/materials - Get current material prices
POST /api/v1/pricing/calculate - Calculate price for project parameters

# User Settings
GET /api/v1/users/pricing-settings - Get user's pricing configuration
PUT /api/v1/users/pricing-settings - Update profit margins and pricing preferences
```

### Component Specifications
**Source: Frontend structure inferred from backend API**

**New React Components Required:**
- `PricingSettingsPage` - User configuration interface for profit margins
- `PricingBreakdownPanel` - Shows internal price calculation details
- `RegionalPricingIndicator` - Shows regional pricing info in quote interface
- `MaterialPriceTracker` - Displays current material cost trends

### File Locations
**Source: backend/src project structure analysis**

**Backend Files to Create:**
- `backend/src/models/pricing_models.py` - New pricing-related database models
- `backend/src/services/regional_pricing_service.py` - Regional pricing logic
- `backend/src/services/material_price_service.py` - Material price API integration
- `backend/src/services/working_time_calculator.py` - Time estimation algorithms
- `backend/src/services/dynamic_pricing_engine.py` - Core pricing calculation engine
- `backend/src/routes/pricing.py` - Pricing API endpoints
- `backend/src/schemas/pricing_schemas.py` - Pricing request/response schemas

**Migration Files:**
- `backend/src/migrations/versions/add_regional_pricing_tables.py`
- `backend/src/migrations/versions/add_material_pricing_tables.py`
- `backend/src/migrations/versions/extend_user_pricing_settings.py`

**Frontend Files to Create:**
- `frontend/src/components/pricing/PricingSettingsPage.tsx`
- `frontend/src/components/pricing/PricingBreakdownPanel.tsx`
- `frontend/src/services/pricingService.ts` - API calls for pricing features

### Testing Requirements
**Source: Architecture inference - testing standards to follow existing patterns**

**Test File Locations:**
- `backend/tests/services/test_dynamic_pricing_engine.py`
- `backend/tests/services/test_regional_pricing_service.py`
- `backend/tests/services/test_material_price_service.py`
- `backend/tests/routes/test_pricing_routes.py`
- `backend/tests/models/test_pricing_models.py`

**Testing Standards:**
- Follow existing FastAPI test patterns using pytest and httpx
- Mock external API calls for material pricing
- Test edge cases: invalid postal codes, API failures, extreme margin settings
- Performance testing for pricing calculations (target <200ms response time)
- Integration tests with quote generation workflow

### Technical Constraints
**Source: backend/src/core/settings.py and architecture analysis**

**Version Requirements:**
- Python 3.8+ (current FastAPI requirement)
- SQLAlchemy 1.4+ for async ORM operations
- External API rate limiting considerations for material pricing
- PostgreSQL for production deployment (currently using SQLite for development)

**Performance Considerations:**
- Cache material prices for 1-4 hours to reduce API calls
- Index postal code ranges for fast regional lookups
- Optimize pricing calculations to complete within 200ms
- Consider background tasks for bulk pricing updates

**Security Rules:**
- Profit margin settings are private to each user
- No pricing details exposed in customer-facing quote PDFs
- Rate limiting on pricing calculation endpoints
- Validate postal codes to prevent injection attacks

### Project Structure Notes
The pricing engine will integrate with existing quote generation system. Current `AIService.process_answers_and_generate_quote()` method already calculates pricing but uses static estimates. The new dynamic pricing engine will replace these calculations with market-based data while maintaining the same quote generation workflow.

## Testing

### Testing Standards
**Source: Existing backend test patterns**

**Test File Locations:**
- Backend tests: `backend/tests/services/` for service classes
- Route tests: `backend/tests/routes/` for API endpoint testing
- Model tests: `backend/tests/models/` for database model validation

**Testing Frameworks:**
- pytest for Python backend testing
- httpx for async API testing
- SQLAlchemy test fixtures for database operations
- Mock external API calls to avoid dependencies during testing

**Specific Testing Requirements:**
- Unit test coverage >80% for all pricing calculation logic
- Integration tests for complete pricing workflow (region detection → material prices → time calculation → final quote)
- Performance tests ensuring pricing calculations complete within 200ms
- Edge case testing for invalid postal codes, API failures, and extreme margin configurations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation | Claude |

## Dev Agent Record

### Agent Model Used
*To be populated during implementation*

### Debug Log References  
*To be populated during implementation*

### Completion Notes List
*To be populated during implementation*

### File List
*To be populated during implementation*

## QA Results
*To be populated by QA Agent after implementation*